#! /usr/bin/env ruby

require 'erb'
require 'fileutils'
require 'pathname'
require 'logger'

logger = Logger.new(STDOUT)

root_dir = Pathname.new(__dir__).join('..')
images_dir = root_dir.join('images')

dockerfile_erb = ERB.new(images_dir.join('Dockerfile.erb').read, trim_mode: '-')
entrypoint_erb = ERB.new(images_dir.join('entrypoint.sh.erb').read, trim_mode: '-')

FileUtils.rm_rf(images_dir.glob('*').select(&:directory?))

node_images = [
  {name: 'node', version: '16', base_image: 'node:16.13.1-bullseye'},
  {name: 'node', version: '14', base_image: 'node:14.18.2-bullseye'},
  {name: 'node', version: '12', base_image: 'node:12.22.7-bullseye'},
]

ruby_images = [
  {name: 'ruby', version: '3.0', base_image: 'ruby:3.0.3-bullseye'},
  {name: 'ruby', version: '2.7', base_image: 'ruby:2.7.5-bullseye'},
  {name: 'ruby', version: '2.6', base_image: 'ruby:2.6.8-bullseye'},
]

[
  *node_images,
  *ruby_images,
  *ruby_images.product(node_images).map {|ruby, node|
    ruby.merge(tag: ruby[:version] + '-node-' + node[:version], node_version: node[:version])
  },
  *node_images.map {|node|
    node.merge(name: 'cypress', tag: 'node-' + node[:version])
  },
  {name: 'rust', base_image: 'rust:1.57.0-bullseye'},
  {name: 'golang', base_image: 'golang:1.17.4-bullseye'},
  {name: 'clojure', base_image: 'clojure:openjdk-11-lein-2.9.6-bullseye'},
  {name: 'docker', base_image: 'debian:11.1'},
  {name: 'qmk', base_image: 'debian:11.1'}
].each do |x|
  logger.info("Processing #{x.inspect}")

  name = x[:name]
  tag = x[:tag] || x[:version]
  base_image = x[:base_image]
  node_version = x[:node_version]

  dir = tag ? images_dir.join(name, tag) : images_dir.join(name)
  FileUtils.mkdir_p(dir)
  dir.join('Dockerfile').write(dockerfile_erb.result(binding))
  dir.join('entrypoint.sh').write(entrypoint_erb.result(binding))
end
